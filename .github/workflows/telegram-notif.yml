name: telegram message
on: [push, pull_request]
jobs:
    notify:
        name: Notify on Push, Pull Request
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Get changed files
              id: changed-files
              uses: tj-actions/changed-files@v44

            - name: Generate changed files message
              id: generate-changed-files-message
              run: |
                  generate_message() {
                    local files="$1"
                    local added=""
                    local modified=""
                    local deleted=""
                    for file in $files; do
                      status=$(git diff --name-status HEAD~1 $file | awk '{print $1}')
                      case "$status" in
                        A)
                          added+="$file %0A"
                          ;;
                        M)
                          modified+="$file %0A"
                          ;;
                        D)
                          deleted+="$file %0A"
                          ;;
                      esac
                    done

                    message="*Changed Files:* %0A"
                    if [ -n "$added" ]; then
                      message+="  ðŸŸ¢ *Added:* %0A   $added"
                    fi
                    if [ -n "$modified" ]; then
                      message+="  ðŸŸ¡ *Modified:* %0A%09$modified"
                    fi
                    if [ -n "$deleted" ]; then
                      message+="  ðŸ”´ *Deleted:* %0A   $deleted"
                    fi

                    echo "::set-output name=message::$message"
                  }

                  generate_message "${{ steps.changed-files.outputs.all_changed_files }}"

            - name: Send Telegram message on push
              if: github.event_name == 'push'
              uses: appleboy/telegram-action@master
              with:
                  to: ${{ secrets.TELEGRAM_TO }}
                  token: ${{ secrets.TELEGRAM_TOKEN }}
                  format: markdown
                  message: |
                      *New Push Notification*
                      ðŸ”¹ *Repository:* ` ${{ github.repository }}`
                      ðŸ”¹ *Pushed by:* ` ${{ github.actor }}`
                      ðŸ”¹ *Pushed to:* ` ${{ github.ref_name }}`
                      ðŸ”¹ *Commit message:* ` ${{ github.event.head_commit.message }}`
                      ðŸ”— View Commit: [Commit Link](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
                      ðŸ”— View Commits History: [Commits History Link](https://github.com/${{ github.repository }}/commit/${{ github.ref_name }})
                      ${{ steps.generate-changed-files-message.outputs.message }}

            - name: Send Telegram message on pull request
              if: github.event_name == 'pull_request'
              uses: appleboy/telegram-action@master
              with:
                  to: ${{ secrets.TELEGRAM_TO }}
                  token: ${{ secrets.TELEGRAM_TOKEN }}
                  format: markdown
                  message: |
                      *New Pull Request Notification*
                      ðŸ”¹ *Repository:* `${{ github.repository }}`
                      ðŸ”¹ *Title:* `${{ github.event.pull_request.title }}`
                      ðŸ”¹ *Author:* `${{ github.event.pull_request.user.login }}`
                      ðŸ”¹ *Description:*
                      `${{ github.event.pull_request.body }}`
                      [View Pull Request](`${{ github.event.pull_request.html_url }})`
                      ${{ steps.generate-changed-files-message.outputs.message }}

            - name: Send Telegram message on stage commit
              if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/stage')
              uses: appleboy/telegram-action@master
              with:
                  to: ${{ secrets.TELEGRAM_TO }}
                  token: ${{ secrets.TELEGRAM_TOKEN }}
                  format: markdown
                  message: |
                      *New Stage Commit Notification*
                      ðŸ”¹ *Repository:* ` ${{ github.repository }}`
                      ðŸ”¹ *Pushed by:* ` ${{ github.actor }}`
                      ðŸ”¹ *Pushed to stage branch:* ` ${{ github.ref_name }}`
                      ðŸ”¹ *Commit message:* ` ${{ github.event.head_commit.message }}`
                      ðŸ”— View Commit: [Commit Link](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
                      ${{ steps.generate-changed-files-message.outputs.message }}
